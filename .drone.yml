---
kind: pipeline
type: kubernetes
name: build-deploy-development-pull-request

platform:
  os: linux
  arch: amd64

steps:
- name: check-for-conventional-commits
  pull: if-not-exists
  image: aevea/commitsar:0.15.0
  commands:
  - commitsar -v -s
  failure: ignore

- name: notify-conventional-commits-6746af5056b569a01aa419d76ca228e9
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - export BUILD_STATUS=$$(cat /run/drone/env | grep DRONE_STAGE_STATUS | cut -d '=' -f 2 | tr -d \")
  - gitea-status -t "conventional-commits" -m "-ignored-" -s "warning" -u "${DRONE_BUILD_LINK}"
  environment:
    GITEA_TOKEN:
      from_secret: GITEA_TOKEN
  when:
    status:
    - failure
    - success

- name: docker-tag-7d9d8b7eed1620f6eefac4a9eca4190b
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - echo -n "`replace-slash ${DRONE_BUILD_NUMBER}`" > .tags
  - echo -n ",`replace-slash ${DRONE_SOURCE_BRANCH}`" >> .tags

- name: docker-image-build
  image: plugins/docker
  settings:
    build_args:
    - ENVIRONMENT=test
    password:
      from_secret: DOCKER_PASSWORD
    registry: registry.vepay.cf
    repo: registry.vepay.cf/${DRONE_REPO,,}
    username:
      from_secret: DOCKER_USERNAME

- name: notify-docker-image-url-657105c17bc1553c117a2cb22deb694f
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - export BUILD_STATUS=$$(cat /run/drone/env | grep DRONE_STAGE_STATUS | cut -d '=' -f 2 | tr -d \")
  - gitea-status -t "docker-image/url" -m "registry.vepay.cf/${DRONE_REPO,,}:`replace-slash ${DRONE_SOURCE_BRANCH}`" -s "success" -u "${DRONE_BUILD_LINK}"
  environment:
    GITEA_TOKEN:
      from_secret: GITEA_TOKEN
  when:
    status:
    - success

- name: fetch-test-data
  pull: always
  image: registry.vepay.cf/${DRONE_REPO,,}:test-data
  commands:
  - cp /data/dump.sql .

- name: import-test-data
  pull: if-not-exists
  image: mariadb:10.4
  commands:
  - mysql -h mariadb -P 3306 -D vepay -u root -pvepay < dump.sql
  - rm dump.sql

- name: prepare-test-env
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - php init --env=test
  - sed -ri -e 's!host=localhost!host=mariadb!g' config/db.php
  - sed -ri -e "s!'password' => ''!'password' => 'vepay'!g" config/db.php
  - sed -ri -e 's!127.0.0.1!redis!g' config/params.php
  - php yii migrate/up --interactive=0

- name: unit-functional-pr-testing
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - php vendor/bin/codecept run unit
  - php vendor/bin/codecept run functional

services:
- name: mariadb
  image: mariadb:10.4
  environment:
    MYSQL_DATABASE: vepay
    MYSQL_PASSWORD: vepay
    MYSQL_ROOT_PASSWORD: vepay
    MYSQL_USER: vepay
  ports:
  - 3306

- name: redis
  image: redis:6
  ports:
  - 6379

image_pull_secrets:
- dockerconfig

trigger:
  branch:
  - develop
  event:
  - pull_request

---
kind: pipeline
type: kubernetes
name: build-deploy-development-push

platform:
  os: linux
  arch: amd64

steps:
- name: docker-tag-295b3c44309601b1d345bccaaede9d84
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - echo -n "`replace-slash ${DRONE_BUILD_NUMBER}`" > .tags
  - echo -n ",`replace-slash ${DRONE_BRANCH}`" >> .tags

- name: docker-image-build
  image: plugins/docker
  settings:
    build_args:
    - ENVIRONMENT=test
    password:
      from_secret: DOCKER_PASSWORD
    registry: registry.vepay.cf
    repo: registry.vepay.cf/${DRONE_REPO,,}
    username:
      from_secret: DOCKER_USERNAME

- name: notify-docker-image-url-eca48fa70abdf632ae75cf9e811aacef
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - export BUILD_STATUS=$$(cat /run/drone/env | grep DRONE_STAGE_STATUS | cut -d '=' -f 2 | tr -d \")
  - gitea-status -t "docker-image/url" -m "registry.vepay.cf/${DRONE_REPO,,}:`replace-slash ${DRONE_BRANCH}`" -s "success" -u "${DRONE_BUILD_LINK}"
  environment:
    GITEA_TOKEN:
      from_secret: GITEA_TOKEN
  when:
    status:
    - success

- name: fetch-test-data
  pull: always
  image: registry.vepay.cf/${DRONE_REPO,,}:test-data
  commands:
  - cp /data/dump.sql .

- name: import-test-data
  pull: if-not-exists
  image: mariadb:10.4
  commands:
  - mysql -h mariadb -P 3306 -D vepay -u root -pvepay < dump.sql
  - rm dump.sql

- name: prepare-test-env
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - php init --env=test
  - sed -ri -e 's!host=localhost!host=mariadb!g' config/db.php
  - sed -ri -e "s!'password' => ''!'password' => 'vepay'!g" config/db.php
  - sed -ri -e 's!127.0.0.1!redis!g' config/params.php
  - php yii migrate/up --interactive=0

- name: unit-functional-pr-testing
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - php vendor/bin/codecept run unit
  - php vendor/bin/codecept run functional

services:
- name: mariadb
  image: mariadb:10.4
  environment:
    MYSQL_DATABASE: vepay
    MYSQL_PASSWORD: vepay
    MYSQL_ROOT_PASSWORD: vepay
    MYSQL_USER: vepay
  ports:
  - 3306

- name: redis
  image: redis:6
  ports:
  - 6379

image_pull_secrets:
- dockerconfig

trigger:
  branch:
  - develop
  event:
  - push

---
kind: secret
name: DOCKER_USERNAME

get:
  path: docker
  name: username

---
kind: secret
name: DOCKER_PASSWORD

get:
  path: docker
  name: password

---
kind: secret
name: KUBE_TOKEN

get:
  path: deploy-app-user-token-v27c8
  name: token

---
kind: secret
name: KUBE_CERTIFICATE

get:
  path: deploy-app-user-token-v27c8
  name: ca.crt

---
kind: secret
name: GITEA_TOKEN

get:
  path: gitea
  name: token

---
kind: signature
hmac: 4cc704f5134f350f4d61b0512531d1e5c41e47575045d9815b44366265239adf

...
