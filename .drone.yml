---
kind: pipeline
type: kubernetes
name: build-deploy-development-pull-request

platform:
  os: linux
  arch: amd64

steps:
- name: check-for-conventional-commits
  pull: if-not-exists
  image: aevea/commitsar:0.15.0
  commands:
  - commitsar -v -s
  failure: ignore

- name: notify-conventional-commits-7ac2812fb6deba1062e461c7b277016c
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - export BUILD_STATUS=$$(cat /run/drone/env | grep DRONE_STAGE_STATUS | cut -d '=' -f 2 | tr -d \")
  - gitea-status -t "conventional-commits" -m "-ignored-" -s "warning" -u "https://www.conventionalcommits.org/en/v1.0.0/#why-use-conventional-commits"
  environment:
    GITEA_TOKEN:
      from_secret: GITEA_TOKEN
  when:
    status:
    - failure
    - success

- name: prepare-test-env
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - php init --env=kube
  - php yii migrate/up --interactive=0
  environment:
    DATABASE_DSN: mysql:host=mariadb;port=3306;dbname=vepay
    DATABASE_USER: vepay
    DATABASE_USER_PASSWORD: vepay
    REDIS_DB_NUM_CACHE: 4
    REDIS_DB_NUM_QUEUE: 3
    REDIS_HOST: redis
    REDIS_PORT: 6379
    TEST_URL: https://test-env-${DRONE_REPO_NAME}.backend.vepay.cf/

- name: unit-functional-pr-testing
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - vendor/bin/codecept run unit
  - vendor/bin/codecept run functional
  - php yii cache/flush-all --interactive 0
  environment:
    DATABASE_DSN: mysql:host=mariadb;port=3306;dbname=vepay
    DATABASE_USER: vepay
    DATABASE_USER_PASSWORD: vepay
    REDIS_DB_NUM_CACHE: 4
    REDIS_DB_NUM_QUEUE: 3
    REDIS_HOST: redis
    REDIS_PORT: 6379
    TEST_URL: https://test-env-${DRONE_REPO_NAME}.backend.vepay.cf/

- name: docker-tag-7d9d8b7eed1620f6eefac4a9eca4190b
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - echo -n "`replace-slash ${DRONE_BUILD_NUMBER}`" > .tags
  - echo -n ",`replace-slash ${DRONE_SOURCE_BRANCH}`" >> .tags

- name: docker-image-build
  pull: always
  image: plugins/docker
  settings:
    build_args:
    - ENVIRONMENT=kube
    compress: true
    password:
      from_secret: DOCKER_PASSWORD
    registry: registry.vepay.cf
    repo: registry.vepay.cf/${DRONE_REPO,,}
    username:
      from_secret: DOCKER_USERNAME

- name: notify-docker-image-url-657105c17bc1553c117a2cb22deb694f
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - export BUILD_STATUS=$$(cat /run/drone/env | grep DRONE_STAGE_STATUS | cut -d '=' -f 2 | tr -d \")
  - gitea-status -t "docker-image/url" -m "registry.vepay.cf/${DRONE_REPO,,}:`replace-slash ${DRONE_SOURCE_BRANCH}`" -s "success" -u "${DRONE_BUILD_LINK}"
  environment:
    GITEA_TOKEN:
      from_secret: GITEA_TOKEN
  when:
    status:
    - success

services:
- name: mariadb
  image: registry.vepay.cf/${DRONE_REPO,,}:maria-test-data
  environment:
    MYSQL_DATABASE: vepay
    MYSQL_PASSWORD: vepay
    MYSQL_RANDOM_ROOT_PASSWORD: yes
    MYSQL_USER: vepay
  ports:
  - 3306

- name: redis
  image: redis:6
  ports:
  - 6379

image_pull_secrets:
- dockerconfig

trigger:
  branch:
  - develop
  event:
  - pull_request

---
kind: pipeline
type: kubernetes
name: build-deploy-development-push

platform:
  os: linux
  arch: amd64

steps:
- name: prepare-test-env
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - php init --env=kube
  - php yii migrate/up --interactive=0
  environment:
    DATABASE_DSN: mysql:host=mariadb;port=3306;dbname=vepay
    DATABASE_USER: vepay
    DATABASE_USER_PASSWORD: vepay
    REDIS_DB_NUM_CACHE: 4
    REDIS_DB_NUM_QUEUE: 3
    REDIS_HOST: redis
    REDIS_PORT: 6379
    TEST_URL: https://test-env-${DRONE_REPO_NAME}.backend.vepay.cf/

- name: unit-functional-pr-testing
  pull: always
  image: registry.vepay.cf/apache-php
  commands:
  - vendor/bin/codecept run unit
  - vendor/bin/codecept run functional
  - php yii cache/flush-all --interactive 0
  environment:
    DATABASE_DSN: mysql:host=mariadb;port=3306;dbname=vepay
    DATABASE_USER: vepay
    DATABASE_USER_PASSWORD: vepay
    REDIS_DB_NUM_CACHE: 4
    REDIS_DB_NUM_QUEUE: 3
    REDIS_HOST: redis
    REDIS_PORT: 6379
    TEST_URL: https://test-env-${DRONE_REPO_NAME}.backend.vepay.cf/

- name: docker-tag-295b3c44309601b1d345bccaaede9d84
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - echo -n "`replace-slash ${DRONE_BUILD_NUMBER}`" > .tags
  - echo -n ",`replace-slash ${DRONE_BRANCH}`" >> .tags

- name: docker-image-build
  pull: always
  image: plugins/docker
  settings:
    build_args:
    - ENVIRONMENT=kube
    compress: true
    password:
      from_secret: DOCKER_PASSWORD
    registry: registry.vepay.cf
    repo: registry.vepay.cf/${DRONE_REPO,,}
    username:
      from_secret: DOCKER_USERNAME

- name: notify-docker-image-url-eca48fa70abdf632ae75cf9e811aacef
  pull: always
  image: registry.vepay.cf/ci-tools
  commands:
  - export BUILD_STATUS=$$(cat /run/drone/env | grep DRONE_STAGE_STATUS | cut -d '=' -f 2 | tr -d \")
  - gitea-status -t "docker-image/url" -m "registry.vepay.cf/${DRONE_REPO,,}:`replace-slash ${DRONE_BRANCH}`" -s "success" -u "${DRONE_BUILD_LINK}"
  environment:
    GITEA_TOKEN:
      from_secret: GITEA_TOKEN
  when:
    status:
    - success

services:
- name: mariadb
  image: registry.vepay.cf/${DRONE_REPO,,}:maria-test-data
  environment:
    MYSQL_DATABASE: vepay
    MYSQL_PASSWORD: vepay
    MYSQL_RANDOM_ROOT_PASSWORD: yes
    MYSQL_USER: vepay
  ports:
  - 3306

- name: redis
  image: redis:6
  ports:
  - 6379

image_pull_secrets:
- dockerconfig

trigger:
  branch:
  - develop
  event:
  - push

---
kind: secret
name: DOCKER_USERNAME

get:
  path: docker
  name: username

---
kind: secret
name: DOCKER_PASSWORD

get:
  path: docker
  name: password

---
kind: secret
name: KUBE_TOKEN

get:
  path: deploy-app-user-token-v27c8
  name: token

---
kind: secret
name: KUBE_CERTIFICATE

get:
  path: deploy-app-user-token-v27c8
  name: ca.crt

---
kind: secret
name: GITEA_TOKEN

get:
  path: gitea
  name: token

---
kind: signature
hmac: 6b7321a03f4871f08001d39301060d6ead9a09bfad874bd42730a5aaa6b082b0

...
